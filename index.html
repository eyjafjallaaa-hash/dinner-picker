<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>这周末吃什么？ · Realtime</title>
  <!-- Tailwind（CDN） -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto px-4 pb-24">
    <!-- 头部：左侧头像图 + 标题 + 房间信息 + 三个阶段按钮 -->
    <header class="py-6 flex items-center justify-between gap-4">
      <div class="min-w-0">
        <div class="flex items-center gap-3">
          <!-- 把你的图片命名为 title.jpg 放在同目录 -->
          <img src="title.jpg" alt="title icon" class="h-12 w-12 rounded-xl object-cover shadow" />
          <!-- 可编辑标题 -->
          <input id="titleInput"
                 class="w-full min-w-0 text-2xl md:text-3xl font-bold bg-transparent border-b border-slate-300 focus:outline-none focus:border-indigo-500 px-1"
                 value="这周末吃什么？" />
        </div>
        <div class="text-sm text-slate-500 mt-1 whitespace-nowrap overflow-hidden text-ellipsis">
          房间：<span id="roomSpan" class="font-mono bg-white rounded px-1 py-0.5"></span> · 把当前链接发给朋友即可同步打分
        </div>
      </div>

      <div class="flex gap-2 shrink-0">
        <button id="btnSetup"
                class="px-3 py-2 rounded-xl border bg-indigo-600 text-white border-indigo-600">
          ① 建立备选
        </button>
        <button id="btnVote"
                class="px-3 py-2 rounded-xl border bg-white text-indigo-600 border-indigo-600">
          ② 打分投票
        </button>
        <button id="btnResults"
                class="px-3 py-2 rounded-xl border bg-white text-indigo-600 border-indigo-600">
          ③ 查看结果
        </button>
      </div>
    </header>

    <!-- 建立备选 -->
    <section id="panelSetup" class="space-y-4">
      <div class="flex items-center gap-2">
        <input id="restInput" class="flex-1 bg-white px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-200"
               placeholder="输入餐厅名称并添加" />
        <button id="btnAdd" class="px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">
          添加
        </button>
      </div>
      <div id="setupList" class="bg-white rounded-xl border divide-y"></div>
      <p id="setupEmpty" class="text-slate-500">还没有备选。先添加几家餐厅吧。</p>
    </section>

    <!-- 打分投票 -->
    <section id="panelVote" class="space-y-4 hidden">
      <div id="voteList" class="bg-white rounded-xl border divide-y"></div>
      <p id="voteEmpty" class="text-slate-500">当前还没有餐厅可投票。</p>
    </section>

    <!-- 结果 -->
    <section id="panelResults" class="space-y-4 hidden">
      <div class="flex gap-2">
        <button id="btnClearVotes" class="px-3 py-2 rounded-lg border bg-white text-indigo-600 border-indigo-600">
          只清空投票（保留备选）
        </button>
        <button id="btnResetAll" class="px-3 py-2 rounded-lg border bg-rose-600 text-white border-rose-600">
          重置（备选与投票全部清空）
        </button>
      </div>
      <div id="resultList" class="bg-white rounded-xl border divide-y"></div>
      <p id="resultEmpty" class="text-slate-500">暂无结果。</p>
    </section>
  </div>

  <!-- Firebase v10（CDN 模块） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getDatabase, ref, onValue, set, update, remove, get, child
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    /* 1) 替换为你的配置 */
    const firebaseConfig = {
      apiKey: "AIzaSyA_C6M0rRXkhfFU_9pFuFBX5FxMOyWoeaY",
      authDomain: "dinner-picker-7dd8f.firebaseapp.com",
      databaseURL: "https://dinner-picker-7dd8f-default-rtdb.firebaseio.com",
      projectId: "dinner-picker-7dd8f",
      storageBucket: "dinner-picker-7dd8f.firebasestorage.app",
      messagingSenderId: "505582469870",
      appId: "1:505582469870:web:bc6912eaa3282c6f8ba9ff"
    };

    /* 2) 初始化 */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    /* 3) DOM */
    const titleInput = document.querySelector('#titleInput');
    const roomSpan = document.querySelector('#roomSpan');

    const btnSetup   = document.querySelector('#btnSetup');
    const btnVote    = document.querySelector('#btnVote');
    const btnResults = document.querySelector('#btnResults');

    const panelSetup   = document.querySelector('#panelSetup');
    const panelVote    = document.querySelector('#panelVote');
    const panelResults = document.querySelector('#panelResults');

    const restInput = document.querySelector('#restInput');
    const btnAdd    = document.querySelector('#btnAdd');
    const setupList = document.querySelector('#setupList');
    const setupEmpty = document.querySelector('#setupEmpty');

    const voteList = document.querySelector('#voteList');
    const voteEmpty = document.querySelector('#voteEmpty');

    const resultList = document.querySelector('#resultList');
    const resultEmpty = document.querySelector('#resultEmpty');

    const btnClearVotes = document.querySelector('#btnClearVotes');
    const btnResetAll   = document.querySelector('#btnResetAll');

    /* 4) 房间 ID */
    const params = new URLSearchParams(location.search);
    const roomId = params.get('room') || 'default_room';
    roomSpan.textContent = roomId;

    /* 5) 登录（匿名） */
    let uid = null;
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user) => { uid = user?.uid || null; });

    /* 数据路径 */
    const roomRef     = ref(db, `rooms/${roomId}`);
    const titleRef    = ref(db, `rooms/${roomId}/title`);
    const restRef     = ref(db, `rooms/${roomId}/restaurants`);
    const votesRef    = ref(db, `rooms/${roomId}/votes`);

    /* 6) 同步标题 */
    // 推 -> 云
    titleInput.addEventListener('input', (e) => {
      set(titleRef, e.target.value);
    });
    // 云 -> 拉
    onValue(titleRef, (snap) => {
      const v = snap.val();
      if (typeof v === 'string' && v !== titleInput.value) titleInput.value = v;
    });

    /* 7) 添加餐厅 */
    btnAdd.addEventListener('click', async () => {
      const name = (restInput.value || '').trim();
      if (!name) return;
      const id = (Date.now() + '_' + Math.random().toString(36).slice(2, 7));
      await set(ref(db, `rooms/${roomId}/restaurants/${id}`), {
        name, createdAt: Date.now()
      });
      restInput.value = '';
    });

    /* 8) 监听餐厅列表 */
    onValue(restRef, (snap) => {
      const data = snap.val() || {};
      renderSetupList(data);
      renderVoteList(data);
      renderResults(data);
    });
    /* 9) 监听投票变化 */
    onValue(votesRef, () => {
      // 只需更新投票区 & 结果区
      get(restRef).then(s => {
        const data = s.val() || {};
        renderVoteList(data);
        renderResults(data);
      });
    });

    /* 渲染：建立备选 */
    function renderSetupList(restaurants) {
      const entries = Object.entries(restaurants || {});
      setupList.innerHTML = '';
      setupEmpty.classList.toggle('hidden', entries.length > 0);

      entries
        .sort((a,b)=> (a[1].createdAt||0)-(b[1].createdAt||0))
        .forEach(([id, item]) => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between px-4 py-3';
          row.innerHTML = `
            <div class="font-medium">${escapeHtml(item.name)}</div>
            <div class="flex items-center gap-2">
              <button data-id="${id}" class="px-3 py-1.5 rounded-lg border text-rose-600 border-rose-600 hover:bg-rose-50">
                删除
              </button>
            </div>
          `;
          row.querySelector('button').addEventListener('click', async (e)=>{
            const rid = e.currentTarget.getAttribute('data-id');
            await remove(ref(db, `rooms/${roomId}/restaurants/${rid}`));
            await remove(ref(db, `rooms/${roomId}/votes/${rid}`)); // 顺手清理该餐厅的票
          });
          setupList.appendChild(row);
        });
    }

    /* 渲染：投票 */
    async function renderVoteList(restaurants) {
      const restEntries = Object.entries(restaurants || {});
      voteList.innerHTML = '';
      voteEmpty.classList.toggle('hidden', restEntries.length > 0);
      // 取我自己的票
      const myVotesSnap = await get(ref(db, `rooms/${roomId}/userVotes/${uid}`));
      const myVotes = myVotesSnap.val() || {};

      for (const [rid, item] of restEntries) {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between px-4 py-3';
        row.innerHTML = `
          <div class="font-medium">${escapeHtml(item.name)}</div>
          <div class="flex items-center gap-2">
            <input type="number" min="1" max="10" step="1"
                   class="w-20 bg-white px-3 py-2 rounded-lg border text-center"
                   value="${myVotes[rid] || ''}" placeholder="1~10" />
            <button class="px-3 py-2 rounded-lg bg-indigo-600 text-white">提交</button>
          </div>
        `;
        const input = row.querySelector('input');
        const btn = row.querySelector('button');
        btn.addEventListener('click', async ()=>{
          const v = Number(input.value);
          if (!Number.isFinite(v) || v < 1 || v > 10) return alert('请输入 1~10 的整数');
          // 记录“每人最后一次评分”为准
          await update(ref(db, `rooms/${roomId}/votes/${rid}`), { [uid]: v });
          await update(ref(db, `rooms/${roomId}/userVotes/${uid}`), { [rid]: v });
        });
        voteList.appendChild(row);
      }
    }

    /* 渲染：结果 */
    async function renderResults(restaurants) {
      const restEntries = Object.entries(restaurants || {});
      resultList.innerHTML = '';
      resultEmpty.classList.toggle('hidden', restEntries.length > 0);

      // 拿所有票
      const votesSnap = await get(votesRef);
      const votes = votesSnap.val() || {};

      const rows = restEntries.map(([rid,item])=>{
        const vmap = votes[rid] || {};
        const vals = Object.values(vmap).map(n=>Number(n)).filter(n=>Number.isFinite(n));
        const count = vals.length;
        const avg = count ? (vals.reduce((a,b)=>a+b,0)/count) : 0;
        return {
          rid,
          name: item.name,
          count,
          avg
        };
      }).sort((a,b)=> b.avg - a.avg);

      rows.forEach((r, idx)=>{
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-4 px-4 py-3 items-center';
        row.innerHTML = `
          <div class="col-span-7 truncate">${escapeHtml(r.name)}</div>
          <div class="col-span-3 text-slate-500">投票数：${r.count}</div>
          <div class="col-span-2 font-semibold text-right">${r.avg ? r.avg.toFixed(2) : '-'}</div>
        `;
        if (idx === 0) row.classList.add('bg-amber-50');
        resultList.appendChild(row);
      });
    }

    /* 清空票/重置 */
    btnClearVotes.addEventListener('click', async ()=>{
      if (!confirm('确定只清空投票？备选会保留。')) return;
      await remove(ref(db, `rooms/${roomId}/votes`));
      await remove(ref(db, `rooms/${roomId}/userVotes`));
      alert('已清空本房间的所有投票。');
    });

    btnResetAll.addEventListener('click', async ()=>{
      if (!confirm('确定重置？将删除本房间的备选与投票。')) return;
      await remove(roomRef);
      alert('已重置房间数据。');
    });

    /* 三个面板切换 */
    const setPhase = (phase) => {
      // 样式
      const active = 'bg-indigo-600 text-white border-indigo-600';
      const normal = 'bg-white text-indigo-600 border-indigo-600';
      btnSetup.className   = `px-3 py-2 rounded-xl border ${phase==='setup'   ? active : normal}`;
      btnVote.className    = `px-3 py-2 rounded-xl border ${phase==='vote'    ? active : normal}`;
      btnResults.className = `px-3 py-2 rounded-xl border ${phase==='results' ? active : normal}`;

      panelSetup.classList.toggle('hidden',   phase!=='setup');
      panelVote.classList.toggle('hidden',    phase!=='vote');
      panelResults.classList.toggle('hidden', phase!=='results');
    };
    btnSetup.onclick   = ()=> setPhase('setup');
    btnVote.onclick    = ()=> setPhase('vote');
    btnResults.onclick = ()=> setPhase('results');
    setPhase('setup'); // 默认落在“建立备选”

    /* 工具 */
    function escapeHtml(s){ return (s??'').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#39;"); }

    // 首次把标题写入（如果房间还没标题）
    (async ()=>{
      const snap = await get(titleRef);
      if (!snap.exists()) await set(titleRef, titleInput.value);
      else titleInput.value = snap.val();
    })();
  </script>
</body>
</html>
