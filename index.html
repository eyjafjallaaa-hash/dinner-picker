<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿™å‘¨æœ«åƒä»€ä¹ˆï¼Ÿ Â· Realtime</title>
  <!-- Tailwindï¼ˆCDNï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto px-4 pb-24">
    <!-- å¤´éƒ¨ï¼šå·¦ä¾§å•å¼ å›¾ç‰‡ + æ ‡é¢˜ + æˆ¿é—´ä¿¡æ¯ + ä¸‰ä¸ªé˜¶æ®µæŒ‰é’® -->
    <header class="py-6 flex items-center justify-between gap-4">
      <div class="min-w-0">
        <div class="flex items-center gap-3">
          <!-- å•å¼ å›¾ç‰‡ï¼ˆå·²æ¢å¤ï¼‰ -->
          <img src="title.jpg" alt="title icon" class="h-12 w-24 rounded-xl object-cover shadow" />
          <!-- å¯ç¼–è¾‘æ ‡é¢˜ï¼ˆäº‘åŒæ­¥ï¼‰ -->
          <input id="titleInput"
                 class="w-full min-w-0 text-2xl md:text-3xl font-bold bg-transparent border-b border-slate-300 focus:outline-none focus:border-indigo-500 px-1"
                 value="è¿™å‘¨æœ«åƒä»€ä¹ˆï¼Ÿ" />
        </div>
        <div class="text-sm text-slate-500 mt-1 whitespace-nowrap overflow-hidden text-ellipsis">
          æˆ¿é—´ï¼š<span id="roomSpan" class="font-mono bg-white rounded px-1 py-0.5"></span> Â· æŠŠå½“å‰é“¾æ¥å‘ç»™æœ‹å‹å³å¯åŒæ­¥æ‰“åˆ†
        </div>
      </div>

      <div class="flex gap-2 shrink-0">
        <button id="btnSetup"
                class="px-3 py-2 rounded-xl border bg-indigo-600 text-white border-indigo-600">
          â‘  å»ºç«‹å¤‡é€‰
        </button>
        <button id="btnVote"
                class="px-3 py-2 rounded-xl border bg-white text-indigo-600 border-indigo-600">
          â‘¡ æ‰“åˆ†æŠ•ç¥¨
        </button>
        <button id="btnResults"
                class="px-3 py-2 rounded-xl border bg-white text-indigo-600 border-indigo-600">
          â‘¢ æŸ¥çœ‹ç»“æœ
        </button>
      </div>
    </header>

    <!-- å»ºç«‹å¤‡é€‰ -->
    <section id="panelSetup" class="space-y-4">
      <div class="flex items-center gap-2">
        <input id="restInput" class="flex-1 bg-white px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-200"
               placeholder="è¾“å…¥é¤å…åç§°å¹¶æ·»åŠ " />
        <button id="btnAdd" class="px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">
          æ·»åŠ 
        </button>
      </div>
      <div id="setupList" class="bg-white rounded-xl border divide-y"></div>
      <p id="setupEmpty" class="text-slate-500">è¿˜æ²¡æœ‰å¤‡é€‰ã€‚å…ˆæ·»åŠ å‡ å®¶é¤å…å§ã€‚</p>
    </section>

    <!-- æ‰“åˆ†æŠ•ç¥¨ï¼ˆä¸€æ¬¡æ€§æäº¤æ‰€æœ‰é€‰é¡¹çš„åˆ†æ•°ï¼‰ -->
    <section id="panelVote" class="space-y-4 hidden">
      <div id="voteList" class="bg-white rounded-xl border divide-y"></div>
      <p id="voteEmpty" class="text-slate-500">å½“å‰è¿˜æ²¡æœ‰é¤å…å¯æŠ•ç¥¨ã€‚</p>
      <div class="flex items-center gap-3">
        <button id="btnSubmitAll"
                class="px-5 py-3 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50">
          æäº¤æœ¬æ¬¡è¯„åˆ†ï¼ˆä¸€æ¬¡æ€§æäº¤æ‰€æœ‰é€‰é¡¹ï¼‰
        </button>
        <span id="voteTip" class="text-slate-500 text-sm"></span>
      </div>
    </section>

    <!-- ç»“æœï¼ˆå«æ ‡å‡†å·®ï¼Œæ’åºè§„åˆ™ï¼šå‡åˆ†é™åº â†’ æ ‡å‡†å·®å‡åº â†’ åç§°å­—æ¯åºï¼›å¹¶åˆ—ä¼˜èƒœï¼‰ -->
    <section id="panelResults" class="space-y-4 hidden">
      <div class="flex gap-2">
        <button id="btnClearVotes" class="px-3 py-2 rounded-lg border bg-white text-indigo-600 border-indigo-600">
          åªæ¸…ç©ºæŠ•ç¥¨ï¼ˆä¿ç•™å¤‡é€‰ï¼‰
        </button>
        <button id="btnResetAll" class="px-3 py-2 rounded-lg border bg-rose-600 text-white border-rose-600">
          é‡ç½®ï¼ˆå¤‡é€‰ä¸æŠ•ç¥¨å…¨éƒ¨æ¸…ç©ºï¼‰
        </button>
      </div>

      <div class="bg-white rounded-xl border overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-slate-100">
              <th class="text-left px-4 py-2">é¤å…</th>
              <th class="text-left px-4 py-2">å‚ä¸äººæ•°</th>
              <th class="text-left px-4 py-2">å¹³å‡åˆ†</th>
              <th class="text-left px-4 py-2">æ ‡å‡†å·®</th>
            </tr>
          </thead>
          <tbody id="resultTbody"></tbody>
        </table>
      </div>

      <p id="resultEmpty" class="text-slate-500">æš‚æ— ç»“æœã€‚</p>
      <div id="winnerBanner" class="hidden mt-2 p-4 rounded-xl bg-emerald-600 text-white"></div>
    </section>
  </div>

  <!-- Firebase v10ï¼ˆCDN æ¨¡å—ï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getDatabase, ref, onValue, set, update, remove, get
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    /* 1) æ›¿æ¢ä¸ºä½ çš„é…ç½® */
    const firebaseConfig = {
      apiKey: "AIzaSyA_C6M0rRXkhfFU_9pFuFBX5FxMOyWoeaY",
      authDomain: "dinner-picker-7dd8f.firebaseapp.com",
      databaseURL: "https://dinner-picker-7dd8f-default-rtdb.firebaseio.com",
      projectId: "dinner-picker-7dd8f",
      storageBucket: "dinner-picker-7dd8f.firebasestorage.app",
      messagingSenderId: "505582469870",
      appId: "1:505582469870:web:bc6912eaa3282c6f8ba9ff"
    };

    /* 2) åˆå§‹åŒ– */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    /* 3) DOM */
    const titleInput   = document.querySelector('#titleInput');
    const roomSpan     = document.querySelector('#roomSpan');
    const btnSetup     = document.querySelector('#btnSetup');
    const btnVote      = document.querySelector('#btnVote');
    const btnResults   = document.querySelector('#btnResults');
    const panelSetup   = document.querySelector('#panelSetup');
    const panelVote    = document.querySelector('#panelVote');
    const panelResults = document.querySelector('#panelResults');

    const restInput  = document.querySelector('#restInput');
    const btnAdd     = document.querySelector('#btnAdd');
    const setupList  = document.querySelector('#setupList');
    const setupEmpty = document.querySelector('#setupEmpty');

    const voteList   = document.querySelector('#voteList');
    const voteEmpty  = document.querySelector('#voteEmpty');
    const btnSubmitAll = document.querySelector('#btnSubmitAll');
    const voteTip      = document.querySelector('#voteTip');

    const resultTbody = document.querySelector('#resultTbody');
    const resultEmpty = document.querySelector('#resultEmpty');
    const winnerBanner = document.querySelector('#winnerBanner');
    const btnClearVotes = document.querySelector('#btnClearVotes');
    const btnResetAll   = document.querySelector('#btnResetAll');

    /* 4) æˆ¿é—´ IDï¼šæ— å‚åˆ™é»˜è®¤ default_roomï¼ˆä½ ä¹‹å‰çš„éœ€æ±‚ï¼‰ */
    const params = new URLSearchParams(location.search);
    const roomId = params.get('room') || 'default_room';
    roomSpan.textContent = roomId;

    /* 5) ç™»å½•ï¼ˆåŒ¿åï¼‰ */
    let uid = null;
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user) => { uid = user?.uid || null; });

    /* æ•°æ®è·¯å¾„ */
    const roomRef   = ref(db, `rooms/${roomId}`);
    const titleRef  = ref(db, `rooms/${roomId}/title`);
    const restRef   = ref(db, `rooms/${roomId}/restaurants`);
    const votesRef  = ref(db, `rooms/${roomId}/votes`);
    const myVotesRef = () => ref(db, `rooms/${roomId}/userVotes/${uid}`);

    /* 6) åŒæ­¥æ ‡é¢˜ */
    titleInput.addEventListener('input', (e) => set(titleRef, e.target.value));
    onValue(titleRef, (snap) => {
      const v = snap.val();
      if (typeof v === 'string' && v !== titleInput.value) titleInput.value = v;
    });

    /* 7) æ·»åŠ /åˆ é™¤é¤å… */
    btnAdd.addEventListener('click', async () => {
      const name = (restInput.value || '').trim();
      if (!name) return;
      const id = (Date.now() + '_' + Math.random().toString(36).slice(2, 7));
      await set(ref(db, `rooms/${roomId}/restaurants/${id}`), {
        name, createdAt: Date.now()
      });
      restInput.value = '';
    });

    onValue(restRef, (snap) => {
      const data = snap.val() || {};
      renderSetupList(data);
      renderVoteList(data);
      renderResults(data);
    });

    onValue(votesRef, () => {
      get(restRef).then(s => {
        const data = s.val() || {};
        renderVoteList(data);
        renderResults(data);
      });
    });

    function renderSetupList(restaurants) {
      const entries = Object.entries(restaurants || {});
      setupList.innerHTML = '';
      setupEmpty.classList.toggle('hidden', entries.length > 0);

      entries
        .sort((a,b)=> (a[1].createdAt||0)-(b[1].createdAt||0))
        .forEach(([id, item]) => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between px-4 py-3';
          row.innerHTML = `
            <div class="font-medium">${escapeHtml(item.name)}</div>
            <div class="flex items-center gap-2">
              <button data-id="${id}" class="px-3 py-1.5 rounded-lg border text-rose-600 border-rose-600 hover:bg-rose-50">
                åˆ é™¤
              </button>
            </div>
          `;
          row.querySelector('button').addEventListener('click', async (e)=>{
            const rid = e.currentTarget.getAttribute('data-id');
            await remove(ref(db, `rooms/${roomId}/restaurants/${rid}`));
            await remove(ref(db, `rooms/${roomId}/votes/${rid}`)); // æ¸…ç†è¯¥é¤å…å¯¹åº”çš„ç¥¨
          });
          setupList.appendChild(row);
        });
    }

    /* æ¸²æŸ“æŠ•ç¥¨ï¼ˆæ— å•é¡¹æäº¤æŒ‰é’®ï¼Œç»Ÿä¸€åœ¨åº•éƒ¨â€œæäº¤æœ¬æ¬¡è¯„åˆ†â€ä¸€æ¬¡æ€§æäº¤ï¼‰ */
    async function renderVoteList(restaurants) {
      const restEntries = Object.entries(restaurants || {});
      voteList.innerHTML = '';
      voteEmpty.classList.toggle('hidden', restEntries.length > 0);
      voteTip.textContent = restEntries.length ? 'è¯·ä¸ºæ¯ä¸ªé¤å…è¾“å…¥ 1~10 çš„æ•´æ•°åˆ†ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹â€œæäº¤æœ¬æ¬¡è¯„åˆ†â€ã€‚' : '';

      const my = (await get(myVotesRef())).val() || {};

      for (const [rid, item] of restEntries) {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between px-4 py-3';
        row.innerHTML = `
          <div class="font-medium">${escapeHtml(item.name)}</div>
          <div class="flex items-center gap-2">
            <input data-rid="${rid}" type="number" min="1" max="10" step="1"
                   class="w-20 bg-white px-3 py-2 rounded-lg border text-center"
                   value="${Number.isFinite(my[rid]) ? my[rid] : ''}" placeholder="1~10" />
          </div>
        `;
        voteList.appendChild(row);
      }
    }

    /* ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰åˆ†æ•° */
    btnSubmitAll.addEventListener('click', async () => {
      const inputs = voteList.querySelectorAll('input[data-rid]');
      if (!inputs.length) return alert('æ²¡æœ‰å¯æŠ•ç¥¨çš„é¤å…ã€‚');

      const scores = {};
      for (const input of inputs) {
        const rid = input.getAttribute('data-rid');
        const v = Number(input.value);
        if (!Number.isFinite(v) || v < 1 || v > 10) {
          input.focus();
          return alert('è¯·ä¸ºæ‰€æœ‰é¤å…è¾“å…¥ 1~10 çš„æ•´æ•°åˆ†åå†æäº¤ã€‚');
        }
        scores[rid] = Math.round(v);
      }

      // æ‰¹é‡å†™å…¥ï¼šæ¯ä¸ªé¤å…è®°å½•â€œuid: scoreâ€ï¼›åŒæ—¶æ›´æ–°æˆ‘çš„ userVotes
      const updates = {};
      for (const [rid, v] of Object.entries(scores)) {
        updates[`rooms/${roomId}/votes/${rid}/${uid}`] = v;
        updates[`rooms/${roomId}/userVotes/${uid}/${rid}`] = v;
      }
      await update(ref(db), updates);
      alert('å·²æäº¤ä½ å¯¹æ‰€æœ‰é¤å…çš„è¯„åˆ†ï¼');
    });

    /* ç»“æœæ¸²æŸ“ï¼šè®¡ç®—å¹³å‡åˆ†ä¸æ ‡å‡†å·®ï¼Œæ’åºä¸å¹¶åˆ—ä¼˜èƒœ */
    async function renderResults(restaurants) {
      const restEntries = Object.entries(restaurants || {});
      resultTbody.innerHTML = '';
      resultEmpty.classList.toggle('hidden', restEntries.length > 0);
      winnerBanner.classList.add('hidden');
      winnerBanner.textContent = '';

      const votesSnap = await get(votesRef);
      const votes = votesSnap.val() || {};
      const rows = restEntries.map(([rid, item]) => {
        const vmap = votes[rid] || {};
        const vals = Object.values(vmap).map(n => Number(n)).filter(n => Number.isFinite(n));
        const count = vals.length;
        const avg = count ? vals.reduce((a,b)=>a+b,0)/count : 0;
        const std = count ? Math.sqrt(vals.reduce((s,x)=> s + Math.pow(x-avg,2), 0)/count) : 0; // æ€»ä½“æ ‡å‡†å·®
        return { rid, name: item.name, count, avg, std };
      });

      // æ’åºï¼šå‡åˆ†é™åº -> æ ‡å‡†å·®å‡åº -> åç§°ï¼ˆç¨³å®šï¼‰
      rows.sort((a,b) => (b.avg - a.avg) || (a.std - b.std) || a.name.localeCompare(b.name));

      // åˆ¤å®šä¼˜èƒœï¼šå‡åˆ†æœ€å¤§è€…é‡Œæ ‡å‡†å·®æœ€å°è€…ï¼›å…è®¸å¹¶åˆ—ï¼ˆå‡åˆ†ä¸æ ‡å‡†å·®éƒ½ç›¸ç­‰ï¼‰
      const eps = 1e-9;
      const bestAvg = rows.reduce((m,r)=> Math.max(m, r.avg || 0), 0);
      const topByAvg = rows.filter(r => Math.abs(r.avg - bestAvg) < eps);
      const bestStd = topByAvg.reduce((m,r)=> Math.min(m, r.std || 0), Number.POSITIVE_INFINITY);
      const winners = rows.filter(r => Math.abs(r.avg - bestAvg) < eps && Math.abs(r.std - bestStd) < eps && r.count > 0);

      // æ¸²æŸ“è¡¨æ ¼
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const isWinner = winners.some(w => w.rid === r.rid);
        tr.className = `border-t ${isWinner ? 'bg-amber-50' : ''}`;
        tr.innerHTML = `
          <td class="px-4 py-2">${escapeHtml(r.name)}</td>
          <td class="px-4 py-2">${r.count}</td>
          <td class="px-4 py-2 font-mono">${r.count ? r.avg.toFixed(2) : '-'}</td>
          <td class="px-4 py-2 font-mono">${r.count ? r.std.toFixed(2) : '-'}</td>
        `;
        resultTbody.appendChild(tr);
      });

      // ä¼˜èƒœæ¨ªå¹…
      if (winners.length) {
        const names = winners.map(w => w.name).join('ã€');
        const text = winners.length === 1
          ? `ğŸ‰ æœ¬è½®ä¼˜èƒœï¼š${names}ï¼ˆå¹³å‡åˆ† ${winners[0].avg.toFixed(2)}ï¼Œæ ‡å‡†å·® ${winners[0].std.toFixed(2)}ï¼‰`
          : `ğŸ‰ æœ¬è½®å¹¶åˆ—ä¼˜èƒœï¼š${names}ï¼ˆå¹³å‡åˆ† ${bestAvg.toFixed(2)}ï¼Œæ ‡å‡†å·® ${bestStd.toFixed(2)}ï¼‰`;
        winnerBanner.textContent = text;
        winnerBanner.classList.remove('hidden');
      }
    }

    /* æ¸…ç©ºç¥¨/é‡ç½® */
    btnClearVotes.addEventListener('click', async ()=>{
      if (!confirm('ç¡®å®šåªæ¸…ç©ºæŠ•ç¥¨ï¼Ÿå¤‡é€‰ä¼šä¿ç•™ã€‚')) return;
      await remove(ref(db, `rooms/${roomId}/votes`));
      await remove(ref(db, `rooms/${roomId}/userVotes`));
      alert('å·²æ¸…ç©ºæœ¬æˆ¿é—´çš„æ‰€æœ‰æŠ•ç¥¨ã€‚');
    });

    btnResetAll.addEventListener('click', async ()=>{
      if (!confirm('ç¡®å®šé‡ç½®ï¼Ÿå°†åˆ é™¤æœ¬æˆ¿é—´çš„å¤‡é€‰ä¸æŠ•ç¥¨ã€‚')) return;
      await remove(roomRef);
      alert('å·²é‡ç½®æˆ¿é—´æ•°æ®ã€‚');
    });

    /* ä¸‰ä¸ªé¢æ¿åˆ‡æ¢ */
    const setPhase = (phase) => {
      const active = 'bg-indigo-600 text-white border-indigo-600';
      const normal = 'bg-white text-indigo-600 border-indigo-600';
      btnSetup.className   = `px-3 py-2 rounded-xl border ${phase==='setup'   ? active : normal}`;
      btnVote.className    = `px-3 py-2 rounded-xl border ${phase==='vote'    ? active : normal}`;
      btnResults.className = `px-3 py-2 rounded-xl border ${phase==='results' ? active : normal}`;

      panelSetup.classList.toggle('hidden',   phase!=='setup');
      panelVote.classList.toggle('hidden',    phase!=='vote');
      panelResults.classList.toggle('hidden', phase!=='results');
    };
    btnSetup.onclick   = ()=> setPhase('setup');
    btnVote.onclick    = ()=> setPhase('vote');
    btnResults.onclick = ()=> setPhase('results');
    setPhase('setup'); // é»˜è®¤è½åœ¨â€œå»ºç«‹å¤‡é€‰â€

    /* å·¥å…· */
    function escapeHtml(s){ return (s??'').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#39;"); }

    // é¦–æ¬¡æŠŠæ ‡é¢˜å†™å…¥ï¼ˆå¦‚æœæˆ¿é—´è¿˜æ²¡æ ‡é¢˜ï¼‰
    (async ()=>{
      const snap = await get(titleRef);
      if (!snap.exists()) await set(titleRef, titleInput.value);
      else titleInput.value = snap.val();
    })();
  </script>
</body>
</html>
