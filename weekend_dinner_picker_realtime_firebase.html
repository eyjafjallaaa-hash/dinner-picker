<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekend Dinner Picker â€” Realtime</title>
  <meta name="description" content="å¤šäººå®æ—¶çº¦é¥­å†³ç­–å™¨ï¼šå»ºå¤‡é€‰ï¼Œ1~10åˆ†æ‰“åˆ†ï¼Œè‡ªåŠ¨ç»Ÿè®¡å¹³å‡åˆ†å¹¶é€‰ä¼˜èƒœï¼ˆFirebase å®æ—¶å…±äº«ï¼‰ã€‚" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='48'%3EğŸ½ï¸%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (in-browser JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase v9 (modular) CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    html,body{height:100%}
    .container{max-width:1100px}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState, useRef } = React;

    // 1) â€”â€” åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Firebase é…ç½® â€”â€”
    const firebaseConfig = {
      apiKey: "AIzaSyA_C6M0rRXkhfFU_9pFuFBX5FxMOyWoeaY",
      authDomain: "dinner-picker-7dd8f.firebaseapp.com",
      databaseURL: "https://dinner-picker-7dd8f-default-rtdb.firebaseio.com",
      projectId: "dinner-picker-7dd8f",
      storageBucket: "dinner-picker-7dd8f.firebasestorage.app",
      messagingSenderId: "505582469870",
      appId: "1:505582469870:web:bc6912eaa3282c6f8ba9ff"
    };

    // 2) åˆå§‹åŒ– Firebaseï¼ˆåŒ¿åç™»å½•ï¼‰
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    function useAnonAuth() {
      const [user, setUser] = useState(null);
      useEffect(() => {
        const off = auth.onAuthStateChanged(u => setUser(u));
        auth.signInAnonymously().catch(console.error);
        return () => off();
      }, []);
      return user;
    }

    // å°å·¥å…·
    const uid = () => Math.random().toString(36).slice(2, 9);
    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));

    // æˆ¿é—´æ•°æ®è®¢é˜… hook
    function useRoom(roomId) {
      const [title, setTitle] = useState("è¿™å‘¨æœ«åƒä»€ä¹ˆï¼Ÿ");
      const [restaurants, setRestaurants] = useState({}); // map: id -> {id,name}
      const [votes, setVotes] = useState({});             // map: id -> {id,voter,uid,scores}

      useEffect(() => {
        if (!roomId) return;
        const rTitle = db.ref(`rooms/${roomId}/title`);
        const rRests = db.ref(`rooms/${roomId}/restaurants`);
        const rVotes = db.ref(`rooms/${roomId}/votes`);

        const off1 = rTitle.on('value', s => setTitle(s.val() || "è¿™å‘¨æœ«åƒä»€ä¹ˆï¼Ÿ"));
        const off2 = rRests.on('value', s => setRestaurants(s.val() || {}));
        const off3 = rVotes.on('value', s => setVotes(s.val() || {}));
        return () => { rTitle.off('value', off1); rRests.off('value', off2); rVotes.off('value', off3); };
      }, [roomId]);

      return { title, setTitleRemote: (t)=>db.ref(`rooms/${roomId}/title`).set(t), restaurants, votes };
    }

    function App() {
      const user = useAnonAuth();
      const [phase, setPhase] = useState('setup'); // setup | vote | results
      const [roomId, setRoomId] = useState(new URLSearchParams(location.search).get('room') || '');
      const [joined, setJoined] = useState(!!roomId);

      const { title, setTitleRemote, restaurants, votes } = useRoom(joined ? roomId : null);

      // è®¡ç®—ç»Ÿè®¡
      const stats = useMemo(() => {
        const restList = Object.values(restaurants);
        const byId = Object.fromEntries(restList.map(r => [r.id, { ...r, sum: 0, cnt: 0 }]));
        Object.values(votes).forEach(v => {
          Object.entries(v.scores || {}).forEach(([rid, score]) => {
            if (byId[rid] && typeof score === 'number') {
              byId[rid].sum += score; byId[rid].cnt += 1;
            }
          });
        });
        const rows = Object.values(byId).map(r => ({ id: r.id, name: r.name, cnt: r.cnt, avg: r.cnt? r.sum/r.cnt : 0 }));
        rows.sort((a,b)=> b.avg - a.avg || a.name.localeCompare(b.name));
        const winner = rows[0] && rows[0].cnt>0 ? rows[0] : null;
        return { rows, winner };
      }, [restaurants, votes]);

      // â€”â€” æˆ¿é—´åŠ å…¥/åˆ›å»º â€”â€”
      const [roomInput, setRoomInput] = useState(roomId);
      const createRoom = async () => {
        const id = (roomInput || '').trim() || 'room-' + uid();
        const now = Date.now();
        await db.ref(`rooms/${id}`).update({
          title: 'è¿™å‘¨æœ«åƒä»€ä¹ˆï¼Ÿ',
          createdAt: now
        });
        setRoomId(id); setJoined(true);
        const url = new URL(location.href); url.searchParams.set('room', id); history.replaceState({}, '', url);
      };
      const joinRoom = async () => {
        const id = (roomInput || '').trim(); if (!id) return alert('è¯·è¾“å…¥æˆ¿é—´å');
        // æ£€æŸ¥å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¹Ÿå…è®¸åŠ å…¥ï¼ˆæ‡’åˆ›å»ºï¼‰
        const snap = await db.ref(`rooms/${id}`).get();
        if (!snap.exists()) {
          if (!confirm('æˆ¿é—´ä¸å­˜åœ¨ï¼Œæ˜¯å¦åˆ›å»ºï¼Ÿ')) return; 
          await db.ref(`rooms/${id}`).set({ title: 'è¿™å‘¨æœ«åƒä»€ä¹ˆï¼Ÿ', createdAt: Date.now() });
        }
        setRoomId(id); setJoined(true);
        const url = new URL(location.href); url.searchParams.set('room', id); history.replaceState({}, '', url);
      };

      if (!user) return <div className="container mx-auto p-6">æ­£åœ¨è¿æ¥â€¦</div>;
      if (!joined) {
        return (
          <div className="container mx-auto p-6 space-y-6">
            <h1 className="text-3xl font-bold">Weekend Dinner Picker â€” å®æ—¶å…±äº«ç‰ˆ</h1>
            <p className="text-slate-600">è¾“å…¥æˆ¿é—´åæ¥åˆ›å»ºæˆ–åŠ å…¥ï¼ˆæŠŠå¸¦æœ‰ <code>?room=æˆ¿é—´å</code> çš„é“¾æ¥åˆ†äº«ç»™æœ‹å‹å³å¯å…±åŒæ‰“åˆ†ï¼‰ã€‚</p>
            <div className="flex gap-2 max-w-xl">
              <input className="flex-1 px-3 py-2 rounded-xl border border-slate-300 focus:border-indigo-500" placeholder="å¦‚ï¼š2025-å‘¨æœ«ç«é”…å±€" value={roomInput} onChange={e=>setRoomInput(e.target.value)} />
              <button className="px-4 py-2 rounded-xl bg-indigo-600 text-white" onClick={createRoom}>åˆ›å»ºæˆ¿é—´</button>
              <button className="px-4 py-2 rounded-xl bg-slate-800 text-white" onClick={joinRoom}>åŠ å…¥æˆ¿é—´</button>
            </div>
            <div className="text-xs text-slate-500">éœ€è¦å…ˆåœ¨ Firebase æ§åˆ¶å°å¡«å¥½æœ¬é¡µé‡Œçš„é…ç½®å¹¶å¯ç”¨åŒ¿åç™»å½•ä¸ Realtime Databaseã€‚è¯¦è§æ–‡ä»¶é¡¶éƒ¨æ³¨é‡Šã€‚</div>
          </div>
        );
      }

      // â€”â€” æˆ¿é—´å†… UI â€”â€”
      return (
        <div className="container mx-auto px-4 pb-24">
          <header className="py-6 flex items-center justify-between">
            <div>
              <input className="text-2xl md:text-3xl font-bold bg-transparent border-b border-slate-300 focus:outline-none focus:border-indigo-500 px-1"
                     value={title}
                     onChange={(e)=>setTitleRemote(e.target.value)} />
              <div className="text-sm text-slate-500 mt-1">æˆ¿é—´ï¼š<span className="font-mono bg-white rounded px-1 py-0.5">{roomId}</span> Â· æŠŠå½“å‰é“¾æ¥å‘ç»™æœ‹å‹å³å¯åŒæ­¥æ‰“åˆ†</div>
            </div>
            <div className="flex gap-2">
              <button className={`px-3 py-2 rounded-xl border ${phase==='setup'? 'bg-indigo-600 text-white border-indigo-600':'bg-white border-slate-300'}`} onClick={()=>setPhase('setup')}>â‘  å»ºç«‹å¤‡é€‰</button>
              <button className={`px-3 py-2 rounded-xl border ${phase==='vote'? 'bg-indigo-600 text-white border-indigo-600':'bg-white border-slate-300'}`} onClick={()=>setPhase('vote')}>â‘¡ æ‰“åˆ†æŠ•ç¥¨</button>
              <button className={`px-3 py-2 rounded-xl border ${phase==='results'? 'bg-indigo-600 text-white border-indigo-600':'bg-white border-slate-300'}`} onClick={()=>setPhase('results')}>â‘¢ æŸ¥çœ‹ç»“æœ</button>
            </div>
          </header>

          {phase==='setup' && <Setup roomId={roomId} restaurants={restaurants} />}
          {phase==='vote' && <Vote roomId={roomId} restaurants={restaurants} votes={votes} uid={user.uid} />}
          {phase==='results' && <Results stats={stats} votesCount={Object.keys(votes).length} goVote={()=>setPhase('vote')} roomId={roomId} />}
        </div>
      );
    }

    function Setup({ roomId, restaurants }) {
      const [newName, setNewName] = useState("");
      const addRestaurant = async () => {
        const name = newName.trim(); if (!name) return;
        const id = 'r-'+Math.random().toString(36).slice(2,9);
        await firebase.database().ref(`rooms/${roomId}/restaurants/${id}`).set({ id, name });
        setNewName("");
      };
      const rename = (id, name) => firebase.database().ref(`rooms/${roomId}/restaurants/${id}/name`).set(name);
      const remove = (id) => firebase.database().ref(`rooms/${roomId}/restaurants/${id}`).remove();

      return (
        <section className="space-y-4">
          <div className="bg-white rounded-2xl shadow p-4">
            <div className="flex gap-2 items-center">
              <input className="flex-1 px-3 py-2 rounded-xl border border-slate-300 focus:border-indigo-500" placeholder="è¾“å…¥é¤å…åç§°å¹¶æ·»åŠ "
                     value={newName} onChange={e=>setNewName(e.target.value)} />
              <button className="px-4 py-2 rounded-xl bg-indigo-600 text-white" onClick={addRestaurant}>æ·»åŠ </button>
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-4">
            {Object.values(restaurants).length===0 && <div className="text-slate-500">è¿˜æ²¡æœ‰å¤‡é€‰ã€‚å…ˆæ·»åŠ å‡ å®¶é¤å…å§ã€‚</div>}
            {Object.values(restaurants).map(r => (
              <div key={r.id} className="bg-white rounded-2xl shadow p-4 flex items-center gap-3">
                <input className="flex-1 px-2 py-1 rounded border border-slate-300 focus:border-indigo-500" value={r.name} onChange={e=>rename(r.id, e.target.value)} />
                <button className="px-3 py-2 rounded-xl bg-rose-100 text-rose-700 hover:bg-rose-200" onClick={()=>remove(r.id)}>åˆ é™¤</button>
              </div>
            ))}
          </div>
        </section>
      );
    }

    function Vote({ roomId, restaurants, votes, uid }) {
      const [voter, setVoter] = useState("");
      const [temp, setTemp] = useState({});
      useEffect(()=>{
        const base = {}; Object.values(restaurants).forEach(r=> base[r.id]=10); setTemp(base);
      }, [restaurants]);

      const submit = async () => {
        if (Object.values(restaurants).length===0) return alert('è¯·å…ˆæ·»åŠ é¤å…');
        const id = 'v-'+Math.random().toString(36).slice(2,9);
        const scores = {}; Object.values(restaurants).forEach(r => scores[r.id] = clamp(Number(temp[r.id] ?? 10), 1, 10));
        await firebase.database().ref(`rooms/${roomId}/votes/${id}`).set({ id, voter: (voter||'').trim() || 'åŒ¿å', uid, scores, ts: Date.now() });
        setVoter("");
      };
      const del = (id, ownerUid) => {
        if (ownerUid && ownerUid !== uid) return alert('åªèƒ½åˆ é™¤è‡ªå·±æäº¤çš„è¯„åˆ†');
        firebase.database().ref(`rooms/${roomId}/votes/${id}`).remove();
      };

      return (
        <section className="space-y-6">
          <div className="bg-white rounded-2xl shadow p-4">
            <div className="flex flex-col md:flex-row md:items-center gap-3">
              <input className="px-3 py-2 rounded-xl border border-slate-300 focus:border-indigo-500 md:w-64" placeholder="ä½ çš„åå­—ï¼ˆå¯ç•™ç©ºï¼‰" value={voter} onChange={e=>setVoter(e.target.value)} />
              <div className="flex-1" />
              <a className="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900" href={location.href} target="_blank">å¤åˆ¶/åˆ†äº«å½“å‰é“¾æ¥</a>
            </div>
          </div>

          <div className="space-y-4">
            {Object.values(restaurants).map(r => (
              <div key={r.id} className="bg-white rounded-2xl shadow p-4">
                <div className="flex items-center justify-between">
                  <div className="font-semibold text-lg">{r.name}</div>
                  <RoomRestAvg roomId={roomId} rid={r.id} />
                </div>
                <div className="mt-3 flex items-center gap-3">
                  <input type="range" min={1} max={10} step={1} value={temp[r.id] ?? 10} onChange={e=>setTemp(s=>({ ...s, [r.id]: Number(e.target.value) }))} className="w-full" />
                  <div className="w-12 text-center font-mono">{temp[r.id] ?? 10}</div>
                </div>
              </div>
            ))}
          </div>

          <div className="flex items-center gap-3">
            <button className="px-5 py-3 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50" onClick={submit} disabled={Object.values(restaurants).length===0}>æäº¤æœ¬æ¬¡è¯„åˆ†</button>
            <div className="text-slate-500">å…± {Object.keys(votes).length} ä»½æŠ•ç¥¨</div>
          </div>

          {Object.keys(votes).length>0 && (
            <div className="bg-white rounded-2xl shadow p-4">
              <div className="font-semibold mb-2">å·²æäº¤çš„è¯„åˆ†</div>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="bg-slate-100">
                      <th className="text-left px-3 py-2">æŠ•ç¥¨äºº</th>
                      {Object.values(restaurants).map(r => <th key={r.id} className="text-left px-3 py-2">{r.name}</th>)}
                      <th className="px-3 py-2" />
                    </tr>
                  </thead>
                  <tbody>
                    {Object.values(votes).sort((a,b)=>a.ts-b.ts).map(v => (
                      <tr key={v.id} className="border-t">
                        <td className="px-3 py-2 whitespace-nowrap font-medium">{v.voter}</td>
                        {Object.values(restaurants).map(r => (
                          <td key={r.id} className="px-3 py-2 font-mono">{v.scores?.[r.id] ?? '-'}</td>
                        ))}
                        <td className="px-3 py-2 text-right">
                          <button className="text-rose-600 hover:underline" onClick={()=>del(v.id, v.uid)}>åˆ é™¤</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </section>
      );
    }

    function Results({ stats, votesCount, goVote, roomId }) {
      const clearVotes = () => {
        if (!confirm('ä»…æ¸…ç©ºè¯„åˆ†ï¼Œä¿ç•™å¤‡é€‰ï¼Ÿ')) return;
        firebase.database().ref(`rooms/${roomId}/votes`).set(null);
      };
      const resetAll = () => {
        if (!confirm('é‡ç½®å°†æ¸…ç©ºå¤‡é€‰å’Œè¯„åˆ†ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
        firebase.database().ref(`rooms/${roomId}`).update({ restaurants: null, votes: null });
      };
      return (
        <section className="space-y-6">
          <div className="bg-white rounded-2xl shadow p-4">
            <div className="flex items-center justify-between">
              <div className="text-xl font-semibold">å¹³å‡åˆ†æ’è¡Œ</div>
              <div className="text-slate-500">å…± {votesCount} ä»½æŠ•ç¥¨</div>
            </div>
            <div className="mt-3 overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="bg-slate-100">
                    <th className="text-left px-3 py-2">åæ¬¡</th>
                    <th className="text-left px-3 py-2">é¤å…</th>
                    <th className="text-left px-3 py-2">å¹³å‡åˆ†</th>
                    <th className="text-left px-3 py-2">å‚ä¸äººæ•°</th>
                  </tr>
                </thead>
                <tbody>
                  {stats.rows.map((r, i) => (
                    <tr key={r.id} className={`border-t ${i===0 && r.cnt>0 ? 'bg-amber-50' : ''}`}>
                      <td className="px-3 py-2 font-mono">{i+1}</td>
                      <td className="px-3 py-2 font-medium">{r.name}</td>
                      <td className="px-3 py-2 font-mono">{r.cnt? r.avg.toFixed(2) : '-'}</td>
                      <td className="px-3 py-2">{r.cnt}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            {stats.winner ? (
              <div className="mt-4 p-4 rounded-xl bg-emerald-600 text-white">ğŸ‰ æœ¬è½®ä¼˜èƒœï¼š<span className="font-bold">{stats.winner.name}</span>ï¼Œå¹³å‡åˆ† {stats.winner.avg.toFixed(2)}ï¼ˆ{stats.winner.cnt} äººå‚ä¸ï¼‰</div>
            ) : (
              <div className="mt-4 text-slate-500">è¿˜æ²¡æœ‰è¯„åˆ†æ•°æ®ã€‚</div>
            )}

            <div className="mt-4 flex gap-2">
              <button className="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900" onClick={goVote}>è¿”å›ç»§ç»­æŠ•ç¥¨</button>
              <button className="px-4 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" onClick={clearVotes}>æ¸…ç©ºè¯„åˆ†ä¿ç•™å¤‡é€‰</button>
              <button className="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700" onClick={resetAll}>é‡ç½®ä¸ºæ–°ä¸€è½®</button>
            </div>
          </div>
        </section>
      );
    }

    function RoomRestAvg({ roomId, rid }) {
      const [avg, setAvg] = useState('-');
      const [cnt, setCnt] = useState(0);
      useEffect(() => {
        const refVotes = firebase.database().ref(`rooms/${roomId}/votes`);
        const off = refVotes.on('value', s => {
          const votes = s.val() || {};
          let sum = 0, c = 0;
          Object.values(votes).forEach(v => {
            const sc = v.scores?.[rid];
            if (typeof sc === 'number') { sum += sc; c += 1; }
          });
          setAvg(c? (sum/c).toFixed(2) : '-'); setCnt(c);
        });
        return () => refVotes.off('value', off);
      }, [roomId, rid]);
      return <div className="text-sm text-slate-500">å½“å‰å¹³å‡ï¼š {avg} ï¼ˆ{cnt} äººï¼‰</div>;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <!-- ä½¿ç”¨é¡»çŸ¥ï¼š
  1ï¼‰åˆ° https://console.firebase.google.com åˆ›å»ºé¡¹ç›® â†’ å¯ç”¨ Authentication çš„ Anonymous ç™»å½•ï¼›
  2ï¼‰Realtime Database é€‰æ‹©ä½ç½®ï¼ˆå»ºè®® asia-southeast1 æˆ– us-central1ï¼‰ï¼Œåˆ›å»ºæ•°æ®åº“ï¼›
  3ï¼‰è§„åˆ™ï¼ˆæœ€ç®€ç¤ºä¾‹ï¼Œç”Ÿäº§ä¸­è¯·æŒ‰éœ€æ”¶ç´§ï¼‰ï¼š
     {
       "rules": {
         "rooms": {
           "$room": {
             ".read": true,
             ".write": "auth != null"
           }
         }
       }
     }
  4ï¼‰æŠŠä¸Šé¢ firebaseConfig é‡Œ YOUR_PROJECT ç­‰æ›¿æ¢ä¸ºä½ çš„é…ç½®ï¼›
  5ï¼‰æ‰“å¼€æœ¬ HTMLï¼Œåˆ›å»º/åŠ å…¥æˆ¿é—´ï¼ˆURL ä¼šå˜æˆ ?room=xxxï¼‰ï¼ŒæŠŠé“¾æ¥å‘æœ‹å‹å³å¯å®æ—¶å…±äº«ã€‚
  -->
</body>
</html>
